@page "{id:int}"
@model InvestmentTracker.Pages.Investments.EditModel
@using InvestmentTracker.Models

<h2>Edit Investment</h2>

<form method="post" class="mt-3">
    <input type="hidden" asp-for="Investment.Id" />

    <div class="mb-3">
        <label asp-for="Investment.Name" class="form-label"></label>
        <input asp-for="Investment.Name" class="form-control" />
        <span asp-validation-for="Investment.Name" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Investment.Provider" class="form-label"></label>
        <input asp-for="Investment.Provider" class="form-control" />
        <span asp-validation-for="Investment.Provider" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Investment.Type" class="form-label"></label>
        <select asp-for="Investment.Type" class="form-select" asp-items="Html.GetEnumSelectList<InvestmentType>()"></select>
    </div>

    <div class="mb-3">
        <label asp-for="Investment.Currency" class="form-label"></label>
        <select asp-for="Investment.Currency" class="form-select" asp-items="Html.GetEnumSelectList<Currency>()"></select>
    </div>

    <div class="mb-3">
        <label asp-for="Investment.ChargeAmount" class="form-label">One-time Charge</label>
        <input asp-for="Investment.ChargeAmount" type="text" inputmode="decimal" class="form-control" value="" placeholder="0.00" autocomplete="off" />
        <span asp-validation-for="Investment.ChargeAmount" class="text-danger"></span>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary">Save</button>
        <a class="btn btn-secondary" asp-page="Index">Cancel</a>
    </div>
</form>

<div class="mb-3 mt-4">
    <h5>Contribution Schedules</h5>
    @if (Model.Investment.Type == InvestmentType.Recurring)
        {
            @if (Model.Schedules?.Any() == true)
            {
                <table class="table table-sm align-middle w-auto schedules-table">
                    <thead>
                        <tr>
                            <th>Start</th>
                            <th>End</th>
                            <th>Day</th>
                            <th>Amount</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var s in Model.Schedules)
                    {
                        var formId = $"updateForm-{s.Id}";
                        <tr>
                            <td>
                                <input class="form-control form-control-sm w-auto" type="date" name="startDate" value="@s.StartDate.ToString("yyyy-MM-dd")" form="@formId" required />
                            </td>
                            <td>
                                <input class="form-control form-control-sm w-auto" type="date" name="endDate" value="@(s.EndDate?.ToString("yyyy-MM-dd"))" form="@formId" />
                            </td>
                            <td>
                                <input class="form-control form-control-sm w-auto" type="number" name="dayOfMonth" min="1" max="31" value="@(s.DayOfMonth ?? s.StartDate.Day)" form="@formId" />
                            </td>
                            <td>
                                <input class="form-control form-control-sm w-auto" type="text" inputmode="decimal" name="amount" value="@s.Amount" form="@formId" required />
                            </td>
                            <td>
                                <form id="@formId" method="post" asp-page-handler="UpdateSchedule" class="update-schedule-form d-inline" data-schedule-id="@s.Id">
                                    <input type="hidden" name="id" value="@Model.Investment.Id" />
                                    <input type="hidden" name="scheduleId" value="@s.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                                </form>
                                <form method="post" asp-page-handler="DeleteSchedule" asp-route-id="@Model.Investment.Id" asp-route-scheduleId="@s.Id" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">No schedules yet.</p>
            }

            <h6 class="mt-3">Add Schedule</h6>
            <form method="post" asp-page-handler="AddSchedule" asp-route-id="@Model.Investment.Id" class="row g-2 align-items-end" id="addScheduleForm">
                <div class="col-auto">
                    <label class="form-label" asp-for="NewSchedule.StartDate">Start</label>
                    <input class="form-control" asp-for="NewSchedule.StartDate" type="date" required />
                    <span class="text-danger" asp-validation-for="NewSchedule.StartDate"></span>
                </div>
                <div class="col-auto">
                    <label class="form-label" asp-for="NewSchedule.EndDate">End</label>
                    <input class="form-control" asp-for="NewSchedule.EndDate" type="date" />
                    <span class="text-danger" asp-validation-for="NewSchedule.EndDate"></span>
                </div>
                <div class="col-auto">
                    <label class="form-label" asp-for="NewSchedule.DayOfMonth">Day</label>
                    <input class="form-control" asp-for="NewSchedule.DayOfMonth" type="number" min="1" max="31" />
                    <span class="text-danger" asp-validation-for="NewSchedule.DayOfMonth"></span>
                </div>
                <div class="col-auto">
                    <label class="form-label" asp-for="NewSchedule.Amount">Amount</label>
                    <input class="form-control" asp-for="NewSchedule.Amount" type="text" inputmode="decimal" value="" placeholder="0.00" required />
                    <span class="text-danger" asp-validation-for="NewSchedule.Amount"></span>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-outline-primary">Add</button>
                </div>
            </form>

            <div class="mt-4">
                <h5>One-time Contributions</h5>
                <form method="post" asp-page-handler="AddContribution" asp-route-id="@Model.Investment.Id" class="row g-2 align-items-end" id="addContributionForm">
                    <div class="col-auto">
                        <label class="form-label" for="NewContribution_Date">Date</label>
                        <input class="form-control" type="date" name="NewContribution.Date" id="NewContribution_Date" required />
                    </div>
                    <div class="col-auto">
                        <label class="form-label" for="NewContribution_Amount">Amount</label>
                        <input class="form-control" type="text" inputmode="decimal" name="NewContribution.Amount" id="NewContribution_Amount" value="" placeholder="0.00" required />
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-outline-primary">Add Contribution</button>
                    </div>
                </form>

                @if (Model.Contributions?.Any() == true)
                {
                    <table class="table table-sm w-auto schedules-table mt-2">
                        <thead><tr><th>Date</th><th>Amount</th><th></th></tr></thead>
                        <tbody>
                        @foreach (var c in Model.Contributions.OrderByDescending(c=>c.Date))
                        {
                            <tr>
                                <td>@c.Date.ToShortDateString()</td>
                                <td>@c.Amount.ToString("C")</td>
                                <td>
                                    <form method="post" asp-page-handler="DeleteContribution" asp-route-id="@Model.Investment.Id" asp-route-contributionId="@c.Id" class="d-inline" data-confirm="Delete this one-time contribution?">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">No one-time contributions.</p>
                }
            </div>
        }
        else
        {
            <p class="text-muted">Contribution schedules apply only to Recurring investments.</p>
        }

        <div class="text-danger mt-2">
            @foreach (var e in ViewData.ModelState.Where(kv => kv.Value?.Errors.Count > 0))
            {
                foreach (var err in e.Value!.Errors)
                {
                    <div>@err.ErrorMessage</div>
                }
            }
        </div>
    </div>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
            function parseDate(val) { return val ? new Date(val + 'T00:00:00') : null; }
            function showError(msg){ alert(msg); }

            const addForm = document.getElementById('addScheduleForm');
            if (addForm) {
                addForm.addEventListener('submit', function(e){
                    const start = parseDate(addForm.querySelector('[name="NewSchedule.StartDate"]').value);
                    const end = parseDate(addForm.querySelector('[name="NewSchedule.EndDate"]').value);
                    const amount = parseFloat(addForm.querySelector('[name="NewSchedule.Amount"]').value.replace(',', '.'));
                    const domInput = addForm.querySelector('[name="NewSchedule.DayOfMonth"]').value;
                    const dom = domInput ? parseInt(domInput, 10) : null;
                    if (!start) { e.preventDefault(); return showError('Start date is required.'); }
                    if (end && end < start) { e.preventDefault(); return showError('End date must be on or after Start date.'); }
                    if (isNaN(amount) || amount <= 0) { e.preventDefault(); return showError('Amount must be greater than 0.'); }
                    if (dom !== null && (dom < 1 || dom > 31)) { e.preventDefault(); return showError('Day of month must be between 1 and 31.'); }
                });
            }

            document.querySelectorAll('form.update-schedule-form').forEach(function(form){
                form.addEventListener('submit', function(e){
                    const start = parseDate(form.querySelector('[name="startDate"]').value);
                    const endVal = form.querySelector('[name="endDate"]').value;
                    const end = parseDate(endVal);
                    const amount = parseFloat(form.querySelector('[name="amount"]').value.replace(',', '.'));
                    const domInput = form.querySelector('[name="dayOfMonth"]').value;
                    const dom = domInput ? parseInt(domInput, 10) : null;
                    if (!start) { e.preventDefault(); return showError('Start date is required.'); }
                    if (end && end < start) { e.preventDefault(); return showError('End date must be on or after Start date.'); }
                    if (isNaN(amount) || amount <= 0) { e.preventDefault(); return showError('Amount must be greater than 0.'); }
                    if (dom !== null && (dom < 1 || dom > 31)) { e.preventDefault(); return showError('Day of month must be between 1 and 31.'); }
                });
            });

            const addContributionForm = document.getElementById('addContributionForm');
            if (addContributionForm) {
                addContributionForm.addEventListener('submit', function(e){
                    const date = parseDate(addContributionForm.querySelector('[name="NewContribution.Date"]').value);
                    const amount = parseFloat(addContributionForm.querySelector('[name="NewContribution.Amount"]').value.replace(',', '.'));
                    if (!date) { e.preventDefault(); return showError('Date is required.'); }
                    if (isNaN(amount) || amount <= 0) { e.preventDefault(); return showError('Amount must be greater than 0.'); }
                });
            }
        })();
    </script>
}


