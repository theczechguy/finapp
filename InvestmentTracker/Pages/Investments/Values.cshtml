@page "{id:int}"
@using System.Globalization
@using InvestmentTracker.Models
@model InvestmentTracker.Pages.Investments.ValuesModel

<h2>Values - @Model.Investment?.Name</h2>
<p>
    <a class="btn btn-secondary" asp-page="List">Back</a>
</p>

@if (Model.Investment is not null)
{
    var culture = CultureInfo.CreateSpecificCulture(Model.Investment.Currency.ToCultureCode());
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Contribution Schedules</h5>
            <div class="mb-2 text-muted">One-time charge: @(Model.Investment.ChargeAmount == 0 ? "-" : Model.Investment.ChargeAmount.ToString("C", culture))</div>
            @if (Model.Investment.Schedules?.Any() == true)
            {
                <ul class="mb-2">
                @foreach (var s in Model.Investment.Schedules.OrderBy(s=>s.StartDate))
                {
                    <li>
                        <strong>@s.Amount.ToString("C", culture)</strong> on day @(s.DayOfMonth?.ToString() ?? s.StartDate.Day.ToString()) from @s.StartDate.ToShortDateString() to @(s.EndDate?.ToShortDateString() ?? "open")
                    </li>
                }
                </ul>
            }
            else
            {
                <p class="text-muted mb-2">No schedules.</p>
            }
            <a class="btn btn-sm btn-primary" asp-page="Edit" asp-route-id="@Model.Investment.Id" title="Edit Schedules" aria-label="Edit Schedules">
                <i class="bi bi-pencil"></i>
            </a>
        </div>
    </div>

    <h5>Add Value</h5>
    <form method="post" asp-page-handler="AddValue" asp-route-id="@Model.Investment.Id" class="row g-3" data-loading="Adding value...">
        <div class="col-auto">
            <input type="hidden" asp-for="NewValue.InvestmentId" />
            <label asp-for="NewValue.AsOf" class="form-label"></label>
            <input asp-for="NewValue.AsOf" class="form-control" type="date" />
            <span asp-validation-for="NewValue.AsOf" class="text-danger"></span>
        </div>
        <div class="col-auto">
            <label asp-for="NewValue.Value" class="form-label"></label>
            @if (ViewData.ModelState.IsValid)
            {
                <input asp-for="NewValue.Value" type="text" inputmode="decimal" class="form-control" value="" placeholder="0.00" autocomplete="off" />
            }
            else
            {
                <input asp-for="NewValue.Value" type="text" inputmode="decimal" class="form-control" placeholder="0.00" autocomplete="off" />
            }
            <span asp-validation-for="NewValue.Value" class="text-danger"></span>
        </div>
        <div class="col-auto">
            <label asp-for="NewValue.ChangeType" class="form-label">Type</label>
            <select asp-for="NewValue.ChangeType" class="form-control">
                <option value="@ValueChangeType.MarketValue">Market Value</option>
                <option value="@ValueChangeType.Buy">Buy</option>
                <option value="@ValueChangeType.Sell">Sell</option>
                <option value="@ValueChangeType.Other">Other</option>
            </select>
            <span asp-validation-for="NewValue.ChangeType" class="text-danger"></span>
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary" title="Add" aria-label="Add">
                <i class="bi bi-plus-lg"></i>
                <span class="d-none d-sm-inline ms-1">Add</span>
            </button>
        </div>
    </form>
    <div class="text-muted small mb-3">
        <i class="bi bi-keyboard me-1"></i>Tip: Press <kbd>A</kbd> to focus value form, <kbd>Enter</kbd> to add
    </div>

    <h5 class="mt-4">One-time Contributions</h5>
    <form method="post" asp-page-handler="AddContribution" asp-route-id="@Model.Investment.Id" class="row g-3" data-loading="Adding contribution...">
        <div class="col-auto">
            <label asp-for="NewContribution.Date" class="form-label">Date</label>
            <input asp-for="NewContribution.Date" type="date" class="form-control" />
            <span asp-validation-for="NewContribution.Date" class="text-danger"></span>
        </div>
        <div class="col-auto">
            <label asp-for="NewContribution.Amount" class="form-label">Amount</label>
            @if (ViewData.ModelState.IsValid)
            {
                <input asp-for="NewContribution.Amount" type="text" inputmode="decimal" class="form-control" value="" placeholder="0.00" autocomplete="off" />
            }
            else
            {
                <input asp-for="NewContribution.Amount" type="text" inputmode="decimal" class="form-control" placeholder="0.00" autocomplete="off" />
            }
            <span asp-validation-for="NewContribution.Amount" class="text-danger"></span>
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary" title="Add Contribution" aria-label="Add Contribution">
                <i class="bi bi-plus-lg"></i>
                <span class="d-none d-sm-inline ms-1">Add Contribution</span>
            </button>
        </div>
    </form>
    <div class="text-muted small mb-3">
        <i class="bi bi-keyboard me-1"></i>Tip: Press <kbd>B</kbd> to focus contribution form, <kbd>Enter</kbd> to add
    </div>

    @if (Model.Investment.OneTimeContributions?.Any() == true)
    {
        <div class="table-responsive">
        <table class="table table-striped table-sm mt-2">
            <thead><tr><th>Date</th><th>Amount</th><th></th></tr></thead>
            <tbody>
            @foreach (var c in Model.Investment.OneTimeContributions.OrderByDescending(c=>c.Date))
            {
                <tr>
                    <td>@c.Date.ToShortDateString()</td>
                    <td>@c.Amount.ToString("C", culture)</td>
                    <td>
                        <form method="post" asp-page-handler="DeleteContribution" asp-route-id="@Model.Investment.Id" asp-route-contributionId="@c.Id" data-confirm="Delete this one-time contribution?" data-loading="Deleting contribution...">
                            <button type="submit" class="btn btn-sm btn-danger" title="Delete" aria-label="Delete"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
        </div>
    }

    <h5 class="mt-4">History</h5>
    
    @if (Model.Investment?.Values?.Any() == true)
    {
        var changeTypeSummary = Model.Investment.Values
            .GroupBy(v => v.ChangeType)
            .Select(g => new { Type = g.Key, Count = g.Count(), TotalValue = g.Sum(v => v.Value) })
            .OrderByDescending(x => x.Count)
            .ToList();
        
        <div class="mb-3">
            <small class="text-muted">Change Type Summary:</small>
            @foreach (var summary in changeTypeSummary)
            {
                <span class="badge me-2 
                    @(summary.Type == ValueChangeType.MarketValue ? "bg-secondary" : 
                      summary.Type == ValueChangeType.Buy ? "bg-success" : 
                      summary.Type == ValueChangeType.Sell ? "bg-danger" : "bg-warning")">
                    @summary.Type (@summary.Count)
                </span>
            }
        </div>
    }
    
    <div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Date</th>
                <th>Value</th>
                <th>Type</th>
                <th>Change</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @{
            // Prepare a list of values ordered newest-first and compute month-over-month percent changes
            var valuesList = Model.Investment?.Values?.OrderByDescending(v => v.AsOf).ToList() ?? new List<InvestmentValue>();
            var changeMap = new Dictionary<int, decimal?>();
            for (int i = 0; i < valuesList.Count; i++)
            {
                var current = valuesList[i];
                var older = (i + 1) < valuesList.Count ? valuesList[i + 1] : null; // the immediately previous (older) snapshot
                if (older is not null && older.Value != 0)
                {
                    changeMap[current.Id] = ((current.Value - older.Value) / older.Value) * 100;
                }
                else
                {
                    changeMap[current.Id] = null; // not applicable (no prior snapshot or division by zero)
                }
            }
        }
        @foreach (var v in valuesList)
        {
            decimal? changePercentNullable = changeMap.ContainsKey(v.Id) ? changeMap[v.Id] : null;
            var changeClass = changePercentNullable.HasValue
                ? (changePercentNullable.Value > 0 ? "text-success" : changePercentNullable.Value < 0 ? "text-danger" : "text-muted")
                : "text-muted";
            string? changeDisplay = changePercentNullable.HasValue
                ? changePercentNullable.Value.ToString("+#.##;-#.##;0") + "%"
                : null;
            <tr>
                <td>@v.AsOf.ToShortDateString()</td>
                <td>@v.Value.ToString("C", culture)</td>
                <td>
                    <span class="badge 
                        @(v.ChangeType == ValueChangeType.MarketValue ? "bg-secondary" : 
                          v.ChangeType == ValueChangeType.Buy ? "bg-success" : 
                          v.ChangeType == ValueChangeType.Sell ? "bg-danger" : "bg-warning")">
                        @v.ChangeType.ToString()
                    </span>
                </td>
                <td class="@changeClass">
                    @if (changePercentNullable.HasValue)
                    {
                        <small>@(changeDisplay)</small>
                    }
                    else
                    {
                        <small class="text-muted">-</small>
                    }
                </td>
                <td>
                    <form method="post" asp-page-handler="Delete" asp-route-id="@(Model.Investment?.Id ?? 0)" asp-route-valueId="@v.Id" data-confirm="Delete this value record?" data-loading="Deleting value...">
                        <button type="submit" class="btn btn-sm btn-danger" title="Delete" aria-label="Delete"><i class="bi bi-trash"></i></button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>
    </div>
}

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
}
