@page "{id:int}"
@using System.Globalization
@using InvestmentTracker.Models
@model InvestmentTracker.Pages.Investments.ValuesModel

<h2>Values - @Model.Investment?.Name</h2>
<p>
    <a class="btn btn-secondary" asp-page="List">Back</a>
</p>

@if (Model.Investment is not null)
{
    var culture = CultureInfo.CreateSpecificCulture(Model.Investment.Currency.ToCultureCode());
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Contribution Schedules</h5>
            <div class="mb-2 text-muted">One-time charge: @(Model.Investment.ChargeAmount == 0 ? "-" : Model.Investment.ChargeAmount.ToString("C", culture))</div>
            @if (Model.Investment.Schedules?.Any() == true)
            {
                <ul class="mb-2">
                @foreach (var s in Model.Investment.Schedules.OrderBy(s=>s.StartDate))
                {
                    <li>
                        <strong>@s.Amount.ToString("C", culture)</strong> on day @(s.DayOfMonth?.ToString() ?? s.StartDate.Day.ToString()) from @s.StartDate.ToShortDateString() to @(s.EndDate?.ToShortDateString() ?? "open")
                    </li>
                }
                </ul>
            }
            else
            {
                <p class="text-muted mb-2">No schedules.</p>
            }
            <a class="btn btn-sm btn-outline-primary" asp-page="Edit" asp-route-id="@Model.Investment.Id">Edit Schedules</a>
        </div>
    </div>

    <h5>Add Value</h5>
    <form method="post" asp-page-handler="AddValue" asp-route-id="@Model.Investment.Id" class="row g-3" data-loading="Adding value...">
        <div class="col-auto">
            <input type="hidden" asp-for="NewValue.InvestmentId" />
            <label asp-for="NewValue.AsOf" class="form-label"></label>
            <input asp-for="NewValue.AsOf" class="form-control" type="date" />
            <span asp-validation-for="NewValue.AsOf" class="text-danger"></span>
        </div>
        <div class="col-auto">
            <label asp-for="NewValue.Value" class="form-label"></label>
            @if (ViewData.ModelState.IsValid)
            {
                <input asp-for="NewValue.Value" type="text" inputmode="decimal" class="form-control" value="" placeholder="0.00" autocomplete="off" />
            }
            else
            {
                <input asp-for="NewValue.Value" type="text" inputmode="decimal" class="form-control" placeholder="0.00" autocomplete="off" />
            }
            <span asp-validation-for="NewValue.Value" class="text-danger"></span>
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary">Add</button>
        </div>
    </form>

    <h5 class="mt-4">One-time Contributions</h5>
    <form method="post" asp-page-handler="AddContribution" asp-route-id="@Model.Investment.Id" class="row g-3" data-loading="Adding contribution...">
        <div class="col-auto">
            <label asp-for="NewContribution.Date" class="form-label">Date</label>
            <input asp-for="NewContribution.Date" type="date" class="form-control" />
            <span asp-validation-for="NewContribution.Date" class="text-danger"></span>
        </div>
        <div class="col-auto">
            <label asp-for="NewContribution.Amount" class="form-label">Amount</label>
            @if (ViewData.ModelState.IsValid)
            {
                <input asp-for="NewContribution.Amount" type="text" inputmode="decimal" class="form-control" value="" placeholder="0.00" autocomplete="off" />
            }
            else
            {
                <input asp-for="NewContribution.Amount" type="text" inputmode="decimal" class="form-control" placeholder="0.00" autocomplete="off" />
            }
            <span asp-validation-for="NewContribution.Amount" class="text-danger"></span>
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-outline-primary">Add Contribution</button>
        </div>
    </form>

    @if (Model.Investment.OneTimeContributions?.Any() == true)
    {
        <table class="table table-sm mt-2">
            <thead><tr><th>Date</th><th>Amount</th><th></th></tr></thead>
            <tbody>
            @foreach (var c in Model.Investment.OneTimeContributions.OrderByDescending(c=>c.Date))
            {
                <tr>
                    <td>@c.Date.ToShortDateString()</td>
                    <td>@c.Amount.ToString("C", culture)</td>
                    <td>
                        <form method="post" asp-page-handler="DeleteContribution" asp-route-id="@Model.Investment.Id" asp-route-contributionId="@c.Id" data-confirm="Delete this one-time contribution?" data-loading="Deleting contribution...">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }

    <h5 class="mt-4">History</h5>
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Date</th>
                <th>Value</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        @foreach (var v in Model.Investment.Values)
        {
            <tr>
                <td>@v.AsOf.ToShortDateString()</td>
                <td>@v.Value.ToString("C", culture)</td>
                <td>
                    <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Investment.Id" asp-route-valueId="@v.Id" data-confirm="Delete this value record?" data-loading="Deleting value...">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>
}

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
}
