@page
@model InvestmentTracker.Pages.Portfolio.IndexModel
@using System.Globalization
@using InvestmentTracker.Models

@{
    ViewData["Title"] = "Portfolio Overview";
}

<h2>Portfolio Overview</h2>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="portfolioTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="investments-tab" data-bs-toggle="tab" data-bs-target="#investments" type="button" role="tab" aria-controls="investments" aria-selected="false">Investments</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="savings-tab" data-bs-toggle="tab" data-bs-target="#savings" type="button" role="tab" aria-controls="savings" aria-selected="false">Savings</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">History</button>
    </li>
</ul>

<div class="tab-content" id="portfolioTabsContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="row mb-4">
            @foreach (var total in Model.TotalsByCurrency.Where(kv => kv.Value > 0m).OrderBy(kv => kv.Key.ToString()))
            {
                <div class="col-md-6 mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3 border-primary bg-opacity-10" style="background-color: rgba(55, 90, 127, 0.1); backdrop-filter: blur(5px);">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Investments Total (@total.Key)</h5>
                                    <p class="card-text fs-4">@total.Value.ToString("C", CultureInfo.CreateSpecificCulture(total.Key.ToCultureCode()))</p>
                                </div>
                            </div>
                            
                            @if (Model.SavingsTotalsByCurrency.ContainsKey(total.Key) && Model.SavingsTotalsByCurrency[total.Key] > 0)
                            {
                                <div class="card mb-3 border-info bg-opacity-10" style="background-color: rgba(57, 175, 209, 0.1); backdrop-filter: blur(5px);">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-info">Savings Total (@total.Key)</h5>
                                        <p class="card-text fs-4">@Model.SavingsTotalsByCurrency[total.Key].ToString("C", CultureInfo.CreateSpecificCulture(total.Key.ToCultureCode()))</p>
                                    </div>
                                </div>
                            }

                            @if (Model.GrandTotalsByCurrency.ContainsKey(total.Key) && Model.GrandTotalsByCurrency[total.Key] > 0)
                            {
                                <div class="card border-success bg-opacity-10" style="background-color: rgba(0, 188, 140, 0.1); backdrop-filter: blur(5px);">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-success">Total Net Worth (@total.Key)</h5>
                                        <p class="card-text fs-3 fw-bold">@Model.GrandTotalsByCurrency[total.Key].ToString("C", CultureInfo.CreateSpecificCulture(total.Key.ToCultureCode()))</p>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header bg-transparent border-0">
                                    Investments by Category (@total.Key)
                                </div>
                                <div class="card-body">
                                    <canvas id="chart-@total.Key" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <h3 class="mt-4">Investments by Category</h3>
        <div class="row mb-4">
            @foreach (var categoryTotal in Model.TotalsByCategory.OrderBy(kv => kv.Key.ToString()))
            {
                <div class="col-md-6 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-transparent border-0 fw-bold">
                            @categoryTotal.Key
                        </div>
                        <ul class="list-group list-group-flush">
                            @foreach (var currencyTotal in categoryTotal.Value.Where(ct => ct.Value > 0m))
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                                    @currencyTotal.Key
                                    <span class="badge bg-primary rounded-pill">@currencyTotal.Value.ToString("C", CultureInfo.CreateSpecificCulture(currencyTotal.Key.ToCultureCode()))</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Investments Tab -->
    <div class="tab-pane fade" id="investments" role="tabpanel" aria-labelledby="investments-tab">
        <h3 class="mt-4">Latest Investment Values</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>Investment</th>
                    <th>Provider</th>
                    <th>Owner</th>
                    <th>Category</th>
                    <th>Latest Value</th>
                    <th>As Of Date</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var investment in Model.InvestmentsWithLatestValue.Where(i => i.Category != InvestmentCategory.Savings).OrderBy(i => i.Name))
            {
                <tr>
                    <td>@investment.Name</td>
                    <td>@(string.IsNullOrWhiteSpace(investment.Provider) ? "-" : investment.Provider)</td>
                    <td>@(string.IsNullOrWhiteSpace(investment.FamilyMemberName) ? "Family" : investment.FamilyMemberName)</td>
                    <td>@investment.Category</td>
                    @if (investment.LatestValue != null)
                    {
                        <td>@investment.LatestValue.Value.ToString("C", CultureInfo.CreateSpecificCulture(investment.Currency.ToCultureCode()))</td>
                        <td>@investment.LatestValue.AsOf.ToShortDateString()</td>
                        <td>
                            <span class="badge 
                                @(investment.LatestValue.ChangeType == ValueChangeType.MarketValue ? "bg-secondary" : 
                                  investment.LatestValue.ChangeType == ValueChangeType.Buy ? "bg-success" : 
                                  investment.LatestValue.ChangeType == ValueChangeType.Sell ? "bg-danger" : "bg-warning")">
                                @investment.LatestValue.ChangeType.ToString()
                            </span>
                        </td>
                    }
                    else
                    {
                        <td class="text-muted">No value recorded</td>
                        <td class="text-muted">-</td>
                        <td class="text-muted">-</td>
                    }
                </tr>
            }
            </tbody>
            </table>
        </div>
    </div>

    <!-- Savings Tab -->
    <div class="tab-pane fade" id="savings" role="tabpanel" aria-labelledby="savings-tab">
        @if (Model.InvestmentsWithLatestValue.Any(i => i.Category == InvestmentCategory.Savings))
        {
            <h3 class="mt-4">Savings Accounts</h3>
            <div class="table-responsive mb-4">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Account Name</th>
                            <th>Provider</th>
                            <th>Owner</th>
                            <th>Latest Balance</th>
                            <th>As Of Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var investment in Model.InvestmentsWithLatestValue.Where(i => i.Category == InvestmentCategory.Savings).OrderBy(i => i.Name))
                        {
                            <tr>
                                <td>@investment.Name</td>
                                <td>@(string.IsNullOrWhiteSpace(investment.Provider) ? "-" : investment.Provider)</td>
                                <td>@(string.IsNullOrWhiteSpace(investment.FamilyMemberName) ? "Family" : investment.FamilyMemberName)</td>
                                @if (investment.LatestValue != null)
                                {
                                    <td>@investment.LatestValue.Value.ToString("C", CultureInfo.CreateSpecificCulture(investment.Currency.ToCultureCode()))</td>
                                    <td>@investment.LatestValue.AsOf.ToShortDateString()</td>
                                }
                                else
                                {
                                    <td class="text-muted">No value recorded</td>
                                    <td class="text-muted">-</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="alert alert-info mt-4">
                No savings accounts found.
            </div>
        }
    </div>

    <!-- History Tab -->
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="card mb-4 mt-4 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Historical Value</h5>
                <div class="btn-group btn-group-sm" role="group" aria-label="Time range selector">
                    <button type="button" data-range="12m" class="btn time-range-btn @(Model.TimeRange == "12m" ? "btn-primary" : "btn-secondary")">12M</button>
                    <button type="button" data-range="6m" class="btn time-range-btn @(Model.TimeRange == "6m" ? "btn-primary" : "btn-secondary")">6M</button>
                    <button type="button" data-range="2m" class="btn time-range-btn @(Model.TimeRange == "2m" ? "btn-primary" : "btn-secondary")">2M</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="historicalValueChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const chartData = @Html.Raw(Model.ChartDataJson);
                console.log('Chart Data:', chartData);

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded!');
                    return;
                }
                
                for (const [currency, categories] of Object.entries(chartData)) {
                    const canvasId = `chart-${currency}`;
                    const canvas = document.getElementById(canvasId);
                    
                    if (!canvas) {
                        console.error(`Canvas with ID ${canvasId} not found!`);
                        continue;
                    }

                    const ctx = canvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(categories),
                            datasets: [{
                                data: Object.values(categories),
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#fff' // Better visibility in dark mode
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            return `${context.label}: ${value.toLocaleString('en-US', { style: 'currency', currency: currency })}`;
                                        }
                                    }
                                }
                            },
                            hover: {
                                mode: 'nearest',
                                intersect: true
                            }
                        }
                    });
                }

                // Time series chart
                const timeSeriesData = @Html.Raw(Model.ChartTimeSeriesJson);
                console.log('Time Series Data:', timeSeriesData);
                
                let timeSeriesChart = null;
                const timeSeriesCanvas = document.getElementById('historicalValueChart');
                if (timeSeriesCanvas) {
                    const timeSeriesCtx = timeSeriesCanvas.getContext('2d');
                    timeSeriesChart = new Chart(timeSeriesCtx, {
                        type: 'line',
                        data: {
                            labels: timeSeriesData.labels,
                            datasets: [
                                {
                                    label: 'Total Net Worth',
                                    data: timeSeriesData.total,
                                    borderColor: 'rgb(75, 192, 192)', // Teal
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                },
                                {
                                    label: 'Investments',
                                    data: timeSeriesData.investments,
                                    borderColor: 'rgb(54, 162, 235)', // Blue
                                    tension: 0.1,
                                    hidden: false
                                },
                                {
                                    label: 'Savings',
                                    data: timeSeriesData.savings,
                                    borderColor: 'rgb(255, 205, 86)', // Yellow
                                    tension: 0.1,
                                    hidden: false
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#aaa',
                                        callback: function(value) {
                                            return value.toLocaleString();
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: '#aaa'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Date',
                                        color: '#aaa'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: '#fff'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                        
                        document.querySelectorAll('.time-range-btn').forEach(button => {
                            button.addEventListener('click', function() {
                                const range = this.dataset.range;
                                
                                // Update active button
                                document.querySelectorAll('.time-range-btn').forEach(btn => {
                                    btn.classList.remove('btn-primary');
                                    btn.classList.add('btn-secondary');
                                });
                                this.classList.remove('btn-secondary');
                                this.classList.add('btn-primary');

                                fetch(`?handler=ChartData&timeRange=${range}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        timeSeriesChart.data.labels = data.labels;
                                        timeSeriesChart.data.datasets[0].data = data.total;
                                        timeSeriesChart.data.datasets[1].data = data.investments;
                                        timeSeriesChart.data.datasets[2].data = data.savings;
                                        timeSeriesChart.update();
                                    });
                            });
                        });
                    }

                    // Handle tab change to ensure charts render correctly when becoming visible
                    const historyTab = document.getElementById('history-tab');
                    if (historyTab) {
                        historyTab.addEventListener('shown.bs.tab', function (event) {
                            if (timeSeriesChart) {
                                timeSeriesChart.resize();
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            });
        </script>
    }
